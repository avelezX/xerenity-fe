name: Validate Issue Reference

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-issue-ref:
    runs-on: ubuntu-latest
    steps:
      - name: Check for issue reference
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';
            const branch = pr.head.ref || '';
            
            // Check for issue references in body, title, or branch name
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i;
            const issueNumberPattern = /#\d+/;
            
            const hasIssueInBody = issuePattern.test(body) || issueNumberPattern.test(body);
            const hasIssueInTitle = issueNumberPattern.test(title);
            const hasIssueInBranch = /\d+/.test(branch);
            
            if (!hasIssueInBody && !hasIssueInTitle) {
              core.setFailed(
                '❌ Este PR no tiene una issue asociada.\n\n' +
                'Por favor incluye una referencia a la issue en el cuerpo del PR:\n' +
                '  - closes #123\n' +
                '  - fixes #123\n' +
                '  - resolves #123\n\n' +
                'Si no existe la issue, créala primero en: ' +
                `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/new`
              );
            } else {
              console.log('✅ Issue referenciada correctamente');
            }
