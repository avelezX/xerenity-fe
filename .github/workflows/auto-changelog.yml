name: Auto Changelog

on:
  pull_request:
    types: [closed]
    branches: [main, master]

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          AUTHOR="${{ github.event.pull_request.user.login }}"
          TITLE="${{ github.event.pull_request.title }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          BODY="${{ github.event.pull_request.body }}"

          # Extract issue reference
          ISSUE=$(echo "$BODY" | grep -oP '(closes?|fixe?s?|resolves?)\s*#\d+' | head -1 || echo "")

          ENTRY="- **${TITLE}** (${AUTHOR}) - PR #${PR_NUM} ${ISSUE}"

          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Add entry under today's date
          if grep -q "## ${DATE}" CHANGELOG.md; then
            sed -i "/## ${DATE}/a ${ENTRY}" CHANGELOG.md
          else
            sed -i "1a\\n## ${DATE}\n${ENTRY}" CHANGELOG.md
          fi

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --cached --quiet || git commit -m "docs: update changelog [skip ci]"
          git push
